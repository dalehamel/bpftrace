containers:
  production:
    environment: production
    workdir: /
    build:
      command: pipa build -x --push -- ./shopify/docker-static-image
      timeout: 10m
  bionic:
    docker: ubuntu:18.04
  alpine:
    docker: alpine:3.8

steps:
- build: production
- label: Build cmake package
  timeout: 60m
  container: bionic
  git:
    history: true
  run:
  - /app/shopify/install-deps.sh
  - /app/shopify/build.sh
  artifact_paths:
  - /artifacts
- label: Build static binary
  timeout: 60m
  container: alpine
  git:
    history: true
  run:
  - /app/shopify/alpine-build.sh
  - cp /app/build/src/bpftrace /artifacts/bpftrace_static
  - cp /app/build/tests/bpftrace_test /artifacts/bpftrace_test
  - chmod +x /artifacts/bpftrace_static
  - chmod +x /artifacts/bpftrace_test
  - gzip /artifacts/bpftrace_static
  artifact_paths:
  - /artifacts

- wait

- label: Run test binary
  container: alpine
  import_artifacts:
  - pattern: bpftrace_test
    into: /
  run:
  - chmod +x /bpftrace_test
  - /bpftrace_test
